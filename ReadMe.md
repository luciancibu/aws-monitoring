
AWS MONITORING STACK â€“ TERRAFORM + ANSIBLE + GRAFANA / PROMETHEUS / LOKI
=====================================================================

OVERVIEW
--------
This project provisions and deploys a complete AWS-based monitoring stack
using Terraform and Ansible.

Metrics are collected via Prometheus exporters and application endpoints,
then scraped or received by Prometheus.
Logs are collected by Grafana Alloy and stored in Loki.
Grafana is used as the single visualization layer.

##  Application & Monitoring Flow

The diagram below illustrates the full observability flow:
- Prometheus scrapes metrics from the application EC2
- Grafana Alloy pushes logs to Loki
- Grafana queries both Prometheus and Loki

![Architecture Flow](diagrams/architecture-flow.png)

HIGH-LEVEL ARCHITECTURE
----------------------
The infrastructure consists of 5 EC2 instances:

1. Ansible Control Node
   - Executes Ansible playbooks
   - Manages all other EC2 instances

2. Grafana EC2
   - Grafana UI (TCP 3000)
   - Queries Prometheus and Loki

3. Prometheus EC2
   - Prometheus server (TCP 9090)
   - Scrapes metrics from exporters and applications

4. Loki EC2
   - Loki log database (TCP 3100)
   - Receives logs from Alloy agents

5. Application EC2
   - Nginx (HTTP entrypoint)
   - Flask backend application
   - Node Exporter (metrics)
   - Alloy (logs)


NETWORK & ACCESS FLOW
---------------------
- Internet / Users
  -> TCP 80
  -> Application EC2 (Nginx + Flask)

- Admin IPs
  -> TCP 3000
  -> Grafana EC2

- Grafana EC2
  -> TCP 9090 (queries)
  -> Prometheus EC2

- Prometheus EC2
  -> TCP 9100 (scrape)
  -> Application EC2 (Node Exporter)

- Grafana Alloy (on Application EC2)
  -> TCP 3100 (push)
  -> Loki EC2


METRICS FLOW (PROMETHEUS)
------------------------
1. Node Exporter runs on the Application EC2
   - Exposes system metrics on TCP 9100
   - CPU, memory, disk, filesystem, load
   - Synthetic stress logs

2. Flask application exposes:
   - /metrics endpoint

3. Prometheus EC2:
   - Scrapes Node Exporter metrics
   - Scrapes Flask /metrics endpoint
   - Stores time-series metrics

4. Grafana:
   - Queries Prometheus
   - Displays dashboards and alerts


LOGGING FLOW (LOKI)
------------------
1. Applications generate logs on Application EC2:
   - Flask logs
   - Nginx access & error logs

2. Alloy runs on the same Application EC2:
   - Tails log files
   - Enriches logs with labels
   - Pushes logs to Loki

3. Loki EC2:
   - Stores logs
   - Provides log query API

4. Grafana:
   - Queries Loki
   - Visualizes and filters logs

5. Application EC2
   - Nginx (reverse proxy)
   - Flask backend application (/metrics exposed)
   - Node Exporter (system metrics)
   - Grafana Alloy (logs & optional metrics)

REPOSITORY STRUCTURE
--------------------

```text
aws-monitoring/
â”œâ”€â”€ terraform/
â”‚   â”œâ”€â”€ provider.tf          # AWS provider configuration
â”‚   â”œâ”€â”€ instances.tf         # EC2 instances (Grafana, Prometheus, Loki, App, Ansible)
â”‚   â”œâ”€â”€ security.tf          # Security Groups & networking rules
â”‚   â”œâ”€â”€ rds.tf               # RDS MySQL instance
â”‚   â”œâ”€â”€ iam.tf               # IAM roles & policies (Secrets Manager access)
â”‚   â”œâ”€â”€ variables.tf         # Input variables
â”‚   â”œâ”€â”€ outputs.tf           # Terraform outputs
â”‚   â””â”€â”€ templates/
â”‚       â”œâ”€â”€ deploy.tmpl      # Generates deployment script after terraform apply
â”‚       â””â”€â”€ inventory.tmpl   # Generates Ansible inventory
â”‚
â””â”€â”€ ansible/
    â”œâ”€â”€ playbook.yml         # Main Ansible playbook
    â”œâ”€â”€ inventory            # Generated by Terraform
    â””â”€â”€ roles/
        â”œâ”€â”€ grafana/         # Grafana installation & configuration
        â”œâ”€â”€ prometheus/      # Prometheus server setup
        â”œâ”€â”€ loki/            # Loki server setup
        â”œâ”€â”€ node/            # Node Exporter (system metrics)
        â”œâ”€â”€ alloy/           # Grafana Alloy agent (log shipping)
        â”œâ”€â”€ flask/           # Flask app + Nginx configuration
        â””â”€â”€ stress/          # Load & log generation for demo/testing

```

DEPLOYMENT FLOW
---------------
1. Terraform Apply
   - Provisions infrastructure
   - Generates Ansible inventory and deploy script

2. VS Code Task
   - Runs terraform apply
   - Executes generated deploy script

3. Ansible
   - Installs services
   - Configures exporters and agents
   - Starts systemd services


# AWS Monitoring Stack

## ðŸ“Š Grafana Dashboard (Metrics & Logs)

This dashboard shows:
- HTTP request rate and latency
- System CPU, memory, disk usage
- Application warnings and errors via Loki

![Grafana Dashboard](diagrams/grafana-dashboard.png)

---
