from flask import Flask, request
import pymysql
import boto3
import json
import time

app = Flask(__name__)
_secret_cache = None


def get_secret():
    global _secret_cache
    if _secret_cache is None:
        client = boto3.client("secretsmanager", region_name="us-east-1")
        _secret_cache = json.loads(
            client.get_secret_value(
                SecretId="monitoring-mysql-secret"
            )["SecretString"]
        )
    return _secret_cache

def get_conn():
    secret = get_secret()
    for _ in range(20):
        try:
            return pymysql.connect(
                host=secret["host"],
                user=secret["username"],
                password=secret["password"],
                database=secret["dbname"],
                connect_timeout=5
            )
        except pymysql.OperationalError:
            time.sleep(1)
    raise RuntimeError("Could not connect to MySQL")


def init_db():
    conn = get_conn()
    cur = conn.cursor()
    cur.execute("""
        CREATE TABLE IF NOT EXISTS counter (
            id INT PRIMARY KEY,
            views BIGINT NOT NULL
        )
    """)
    cur.execute("""
        INSERT INTO counter (id, views)
        SELECT 1, 0
        WHERE NOT EXISTS (SELECT 1 FROM counter WHERE id=1)
    """)
    conn.commit()
    conn.close()


@app.route("/view")
def view_counter():
    try:
        conn = get_conn()
        cur = conn.cursor()

        read = request.args.get("read") == "true"
        if not read:
            cur.execute("UPDATE counter SET views = views + 1 WHERE id=1")
            conn.commit()

        cur.execute("SELECT views FROM counter WHERE id=1")
        views = cur.fetchone()[0]

        conn.close()
        return str(views)
    except Exception:
        import traceback
        traceback.print_exc()
        return "ERROR", 500


@app.route("/health")
def health():
    try:
        conn = get_conn()
        cur = conn.cursor()
        cur.execute("SELECT 1")
        conn.close()
        return "OK"
    except Exception:
        import traceback
        traceback.print_exc()
        return "FAIL", 500


if __name__ == "__main__":
    init_db()
    app.run(host="0.0.0.0", port={{ flask_port }}, debug=True)
